<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .card {
      background: #ffffff;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    
    h2 {
      color: #333;
      margin-bottom: 24px;
      font-size: 24px;
    }
    
    #emailText {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    
    .password-requirements {
      text-align: right;
      margin-bottom: 16px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 8px;
      font-size: 13px;
      color: #555;
    }
    
    .password-requirements h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #333;
    }
    
    .requirement {
      margin: 4px 0;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    
    .requirement.valid {
      color: #4caf50;
    }
    
    .requirement.invalid {
      color: #f44336;
    }
    
    input {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 2px solid #ddd;
      box-sizing: border-box;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: #1F6EBC;
    }
    
    button {
      padding: 12px;
      width: 100%;
      background: #1F6EBC;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 8px;
    }
    
    button:hover:not(:disabled) {
      background: #155a94;
    }
    
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .message {
      margin-top: 16px;
      font-size: 14px;
      padding: 12px;
      border-radius: 8px;
      min-height: 20px;
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
    <p id="emailText"></p>

    <div class="password-requirements">
      <h3>Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</h3>
      <div class="requirement invalid" id="req-length">
        âœ— Ù…Ù† 8 Ø¥Ù„Ù‰ 16 Ø­Ø±Ù
      </div>
      <div class="requirement invalid" id="req-uppercase">
        âœ— Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (A-Z)
      </div>
      <div class="requirement invalid" id="req-lowercase">
        âœ— Ø­Ø±Ù ØµØºÙŠØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (a-z)
      </div>
      <div class="requirement invalid" id="req-number">
        âœ— Ø±Ù‚Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (0-9)
      </div>
      <div class="requirement invalid" id="req-special">
        âœ— Ø­Ø±Ù Ø®Ø§Øµ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (!@#$%^&*...)
      </div>
    </div>

    <input 
      id="password" 
      type="password" 
      placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
      autocomplete="new-password"
    />

    <button id="submitBtn" onclick="onSubmitNewPassword()">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>

    <div class="message" id="message"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      verifyPasswordResetCode,
      confirmPasswordReset
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ğŸ”¥ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBQwZ7dRf_K8PnBUQINlZOMZksjnaz33yI",
      authDomain: "smart-assistant-228a6.firebaseapp.com",
      databaseURL: "https://smart-assistant-228a6-default-rtdb.firebaseio.com",
      projectId: "smart-assistant-228a6",
      storageBucket: "smart-assistant-228a6.firebasestorage.app",
      messagingSenderId: "1026568655796",
      appId: "1:1026568655796:web:5deeb9c559e5c008b358e1",
      measurementId: "G-C9PEXY3C8J"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const oobCode = params.get("oobCode") || params.get("code");

    const emailText = document.getElementById("emailText");
    const messageDiv = document.getElementById("message");
    const submitBtn = document.getElementById("submitBtn");
    const passwordInput = document.getElementById("password");

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø´Ø±ÙˆØ· Ø§Ù„ØªØ³Ø¬ÙŠÙ„)
    function validatePassword(password) {
      const requirements = {
        length: password.length >= 8 && password.length <= 16,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };

      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      updateRequirementDisplay('req-length', requirements.length);
      updateRequirementDisplay('req-uppercase', requirements.uppercase);
      updateRequirementDisplay('req-lowercase', requirements.lowercase);
      updateRequirementDisplay('req-number', requirements.number);
      updateRequirementDisplay('req-special', requirements.special);

      return Object.values(requirements).every(req => req === true);
    }

    function updateRequirementDisplay(id, isValid) {
      const element = document.getElementById(id);
      if (isValid) {
        element.classList.remove('invalid');
        element.classList.add('valid');
        element.textContent = element.textContent.replace('âœ—', 'âœ“');
      } else {
        element.classList.remove('valid');
        element.classList.add('invalid');
        element.textContent = element.textContent.replace('âœ“', 'âœ—');
      }
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    passwordInput.addEventListener('input', function() {
      const password = this.value;
      if (password.length > 0) {
        validatePassword(password);
      } else {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        ['req-length', 'req-uppercase', 'req-lowercase', 'req-number', 'req-special'].forEach(id => {
          const element = document.getElementById(id);
          element.classList.remove('valid');
          element.classList.add('invalid');
          element.textContent = element.textContent.replace('âœ“', 'âœ—');
        });
      }
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    if (!oobCode) {
      messageDiv.textContent = "Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­.";
      messageDiv.className = "message error";
      submitBtn.disabled = true;
    } else {
      verifyPasswordResetCode(auth, oobCode)
        .then((email) => {
          emailText.textContent = "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø­Ø³Ø§Ø¨: " + email;
          emailText.style.color = "#1F6EBC";
        })
        .catch((error) => {
          console.error("Error verifying code:", error);
          messageDiv.textContent = "Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.";
          messageDiv.className = "message error";
          submitBtn.disabled = true;
        });
    }

    window.onSubmitNewPassword = async function () {
      const newPassword = passwordInput.value;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      if (!validatePassword(newPassword)) {
        messageDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
        messageDiv.className = "message error";
        return;
      }

      if (!oobCode) {
        messageDiv.textContent = "Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­.";
        messageDiv.className = "message error";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«... <span class='loading'></span>";
      messageDiv.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...";
      messageDiv.className = "message info";

      try {
        await confirmPasswordReset(auth, oobCode, newPassword);
        messageDiv.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.";
        messageDiv.className = "message success";
        passwordInput.disabled = true;
        submitBtn.style.display = "none";
      } catch (e) {
        console.error("Error resetting password:", e);
        let errorMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
        
        if (e.code === 'auth/invalid-action-code') {
          errorMessage = "Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.";
        } else if (e.code === 'auth/weak-password') {
          errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ù‚ÙˆÙ‰.";
        }
        
        messageDiv.textContent = errorMessage;
        messageDiv.className = "message error";
        submitBtn.disabled = false;
        submitBtn.innerHTML = "ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
      }
    };
  </script>
</body>
</html>

